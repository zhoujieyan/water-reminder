import{WaterRecorder}from'./src/logic/water-recorder.js';import{AchievementSystem}from'./src/logic/achievement-system.js';import{WeatherService}from'./src/weather/weather-service.js';import{getMessageGenerator}from'./src/logic/message-generator.js';console.log('ğŸ’§ æ°´å®æé†’åº”ç”¨å¯åŠ¨ä¸­...');if('serviceWorker'in navigator){window.addEventListener('load',async()=>{try{const registration=await navigator.serviceWorker.register('service-worker.js');console.log('ServiceWorker æ³¨å†ŒæˆåŠŸ:',registration.scope);registration.addEventListener('updatefound',()=>{const newWorker=registration.installing;console.log('ServiceWorker æ›´æ–°å‘ç°:',newWorker.state);});}catch(error){console.error('ServiceWorker æ³¨å†Œå¤±è´¥:',error);}});}
class WaterReminderApp{constructor(){this.waterRecorder=new WaterRecorder();this.weatherService=new WeatherService();this.achievementSystem=new AchievementSystem();this.achievements=[];this.settings={reminderInterval:60,enableSound:true,enableWeather:true,enableNotifications:true};this.weatherRefreshTimer=null;this.init();}
async init(){console.log('åˆå§‹åŒ–æ°´å®æé†’åº”ç”¨...');try{const recorderInit=await this.waterRecorder.init();if(!recorderInit){throw new Error('å–æ°´è®°å½•å™¨åˆå§‹åŒ–å¤±è´¥');}
const achievementInit=await this.achievementSystem.init();if(!achievementInit){console.warn("âš ï¸ æˆå°±ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œä½†åº”ç”¨å°†ç»§ç»­è¿è¡Œ");}
this.bindEvents();this.updateUI();this.checkNotificationPermission();await this.initWeatherModule();console.log('âœ… åº”ç”¨åˆå§‹åŒ–å®Œæˆï¼');}catch(error){await this.checkAchievements();console.error('âŒ åº”ç”¨åˆå§‹åŒ–å¤±è´¥:',error);this.showErrorMessage('åº”ç”¨åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');}}
bindEvents(){const drinkBtn=document.getElementById('drinkBtn');if(drinkBtn){drinkBtn.addEventListener('click',()=>this.handleDrink());}
const settingsBtn=document.getElementById('settingsBtn');if(settingsBtn){settingsBtn.addEventListener('click',()=>this.openSettings());}
const historyBtn=document.getElementById('historyBtn');if(historyBtn){historyBtn.addEventListener('click',()=>this.openHistory());}
const achievementsBtn=document.getElementById('achievementsBtn');if(achievementsBtn){achievementsBtn.addEventListener('click',()=>this.openAchievements());}
const weeklyReportBtn=document.getElementById('weeklyReportBtn');if(weeklyReportBtn){weeklyReportBtn.addEventListener('click',()=>this.handleWeeklyReport());}
const messagePreviewBtn=document.getElementById('messagePreviewBtn');if(messagePreviewBtn){messagePreviewBtn.addEventListener('click',()=>this.openMessagePreview());}
const closeMessagePreviewBtn=document.getElementById('closeMessagePreviewBtn');if(closeMessagePreviewBtn){closeMessagePreviewBtn.addEventListener('click',()=>this.closeMessagePreviewModal());}
const closeAchievementsBtn=document.getElementById("closeAchievementsBtn");if(closeAchievementsBtn){closeAchievementsBtn.addEventListener("click",()=>this.closeAchievementsModal());}
window.addEventListener('online',()=>this.handleOnline());window.addEventListener('offline',()=>this.handleOffline());window.addEventListener('beforeinstallprompt',(e)=>{e.preventDefault();console.log('PWA å®‰è£…æç¤ºå¯ç”¨');this.deferredPrompt=e;});if(window.location.hostname==='localhost'||window.location.hostname==='127.0.0.1'){this.addDebugButtons();}}
async handleDrink(){console.log('ğŸ¥¤ è®°å½•å–æ°´...');this.playDrinkAnimation();const success=await this.waterRecorder.recordDrink();if(success){this.updateUI();this.checkAchievements();this.showToast('å–æ°´è®°å½•æˆåŠŸï¼','success');}else{this.showToast('è®°å½•å¤±è´¥ï¼Œè¯·é‡è¯•','error');}}
updateUI(){const state=this.waterRecorder.getState();const stats=state.stats;console.log('ğŸ”„ æ›´æ–°UIï¼Œç»Ÿè®¡æ•°æ®:',stats);const todayCountEl=document.getElementById('todayCount');if(todayCountEl){todayCountEl.textContent=`${stats.todayCount}æ¯`;}
const targetCountEl=document.getElementById('targetCount');if(targetCountEl){targetCountEl.textContent=`${stats.weatherAdjustedGoal}æ¯`;}
const completionRateEl=document.getElementById('completionRate');if(completionRateEl){completionRateEl.textContent=`${stats.completionRate}%`;}
const progressBar=document.getElementById('progressBar');if(progressBar){progressBar.style.width=`${stats.completionRate}%`;progressBar.style.transition='width 0.5s ease';}
const progressText=document.getElementById('progressText');if(progressText){progressText.textContent=`${stats.todayCount}/${stats.weatherAdjustedGoal}æ¯`;}
const waterLevel=document.getElementById('waterLevel');if(waterLevel){const waterHeight=Math.min(100,stats.completionRate);waterLevel.style.height=`${waterHeight}%`;waterLevel.style.transition='height 0.5s ease';}
const cupFace=document.getElementById('cupFace');if(cupFace){if(stats.completionRate>=100){cupFace.textContent='ğŸ‰';}else if(stats.completionRate>=75){cupFace.textContent='ğŸ˜„';}else if(stats.completionRate>=50){cupFace.textContent='ğŸ˜Š';}else if(stats.completionRate>=25){cupFace.textContent='ğŸ˜';}else{cupFace.textContent='ğŸ˜Ÿ';}}
const statusText=document.getElementById('statusText');if(statusText){if(stats.todayCount===0){statusText.textContent='ä»Šå¤©è¿˜æ²¡å–æ°´å‘¢ï¼Œå¿«å¼€å§‹å§ï¼';}else if(stats.completionRate>=100){statusText.textContent='å¤ªæ£’äº†ï¼ä»Šæ—¥ç›®æ ‡å·²å®Œæˆï¼ğŸŠ';}else{statusText.textContent=`åŠ æ²¹ï¼è¿˜éœ€è¦å– ${stats.remainingCups}æ¯æ°´~`;}}
this.updateDetailedStats(stats);this.updateWaterRecommendation(stats);}
updateDetailedStats(stats){let detailedStatsEl=document.getElementById('detailedStats');if(!detailedStatsEl){const statsSection=document.querySelector('.stats-section');if(statsSection){detailedStatsEl=document.createElement('div');detailedStatsEl.id='detailedStats';detailedStatsEl.className='detailed-stats';detailedStatsEl.innerHTML=`<div class="stat-row"><span class="stat-label">åŸºç¡€ç›®æ ‡ï¼š</span><span class="stat-value"id="baseGoal">${stats.goal}æ¯</span></div><div class="stat-row"><span class="stat-label">å¤©æ°”è°ƒæ•´ï¼š</span><span class="stat-value"id="weatherAdjustment">${stats.weatherAdjustment>0?'+':''}${stats.weatherAdjustment}æ¯</span></div><div class="stat-row"><span class="stat-label">å‰©ä½™æ¯æ•°ï¼š</span><span class="stat-value"id="remainingCups">${stats.remainingCups}æ¯</span></div>`;statsSection.parentNode.insertBefore(detailedStatsEl,statsSection.nextSibling);}}else{const baseGoalEl=document.getElementById('baseGoal');const weatherAdjustmentEl=document.getElementById('weatherAdjustment');const remainingCupsEl=document.getElementById('remainingCups');if(baseGoalEl)baseGoalEl.textContent=`${stats.goal}æ¯`;if(weatherAdjustmentEl)weatherAdjustmentEl.textContent=`${stats.weatherAdjustment>0?'+':''}${stats.weatherAdjustment}æ¯`;if(remainingCupsEl)remainingCupsEl.textContent=`${stats.remainingCups}æ¯`;}}
updateWaterRecommendation(stats){const waterRecommendationEl=document.getElementById('waterRecommendation');if(waterRecommendationEl){const recommendedML=stats.weatherAdjustedGoal*200;waterRecommendationEl.textContent=`æ¨èå–æ°´é‡ï¼š${recommendedML}ml(çº¦${stats.weatherAdjustedGoal}æ¯)`;}}
playDrinkAnimation(){const cup=document.getElementById('cup');if(cup){cup.classList.remove('bounce');void cup.offsetWidth;cup.classList.add('bounce');setTimeout(()=>{cup.classList.remove('bounce');},500);}
const drinkBtn=document.getElementById('drinkBtn');if(drinkBtn){drinkBtn.classList.add('pulse');setTimeout(()=>drinkBtn.classList.remove('pulse'),1000);}
this.addWaterSplashEffect();}
addWaterSplashEffect(){const cupContainer=document.querySelector('.cup-container');if(!cupContainer)return;for(let i=0;i<5;i++){const drop=document.createElement('div');drop.className='water-drop';const startX=50+(Math.random()*20-10);const startY=50+(Math.random()*20-10);const delay=Math.random()*0.3;drop.style.cssText=`position:absolute;width:8px;height:8px;background:var(--primary-blue-light);border-radius:50%;left:${startX}%;top:${startY}%;opacity:0.8;animation:drop-splash 0.8s ease-out ${delay}s forwards;z-index:10;`;cupContainer.appendChild(drop);setTimeout(()=>{if(drop.parentNode){drop.parentNode.removeChild(drop);}},1000+delay*1000);}}
async checkAchievements(){try{const state=this.waterRecorder.getState();const stats=state.stats;const userStats=await this.achievementSystem.calculateUserStats();const context={todayCount:stats.todayCount,weatherAdjustedGoal:stats.weatherAdjustedGoal,weatherAdjustment:stats.weatherAdjustment,streakDays:userStats.streakDays,totalCups:userStats.totalCups,hasDrinkToday:userStats.hasDrinkToday};const unlockedAchievements=await this.achievementSystem.checkAndUnlockAchievements(context);if(unlockedAchievements.length>0){this.achievements.push(...unlockedAchievements);this.showAchievementNotification(unlockedAchievements);this.refreshAchievementsModal();}}catch(error){console.error('æ£€æŸ¥æˆå°±å¤±è´¥:',error);}}
showAchievementNotification(achievements){console.log('ğŸ‰ æ–°æˆå°±è§£é”:',achievements);const notification=document.createElement('div');notification.className='achievement-notification';const achievement=achievements[0];notification.innerHTML=`<div class="achievement-badge">${achievement.icon}</div><div class="achievement-content"><h3>æˆå°±è§£é”ï¼</h3><p><strong>${achievement.name}</strong></p><p>${achievement.description}</p></div>`;notification.style.cssText=`position:fixed;top:20px;right:20px;background:white;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,0.15);padding:16px;display:flex;align-items:center;gap:16px;z-index:1000;animation:slide-in 0.5s ease;border:3px solid var(--accent-yellow);max-width:320px;`;document.body.appendChild(notification);setTimeout(()=>{if(notification.parentNode){notification.style.animation='slide-out 0.5s ease forwards';setTimeout(()=>{if(notification.parentNode){notification.parentNode.removeChild(notification);}},500);}},5000);}
async openAchievements(){console.log('ğŸ† æ‰“å¼€æˆå°±ç³»ç»Ÿ');try{const modal=document.getElementById('achievementsModal');if(modal){modal.classList.add('show');modal.style.display='flex';await this.refreshAchievementsModal();}}catch(error){console.error('æ‰“å¼€æˆå°±ç•Œé¢å¤±è´¥:',error);this.showToast('æ— æ³•åŠ è½½æˆå°±æ•°æ®','error');}}
async refreshAchievementsModal(){try{const achievementsList=document.getElementById('achievementsList');const unlockedCountEl=document.getElementById('unlockedCount');const totalAchievementsCountEl=document.getElementById('totalAchievementsCount');const completionPercentageEl=document.getElementById('completionPercentage');if(!achievementsList)return;achievementsList.innerHTML='<div class="loading-spinner">åŠ è½½æˆå°±æ•°æ®...</div>';const allAchievements=await this.achievementSystem.getAllAchievements();const unlockedAchievements=await this.achievementSystem.getUnlockedAchievements();const lockedAchievements=allAchievements.filter(a=>!a.unlocked_date);if(unlockedCountEl){unlockedCountEl.textContent=unlockedAchievements.length;}
if(totalAchievementsCountEl){totalAchievementsCountEl.textContent=allAchievements.length;}
if(completionPercentageEl){const percentage=allAchievements.length>0?Math.round((unlockedAchievements.length/allAchievements.length)*100):0;completionPercentageEl.textContent=`${percentage}%`;}
achievementsList.innerHTML='';for(const achievement of unlockedAchievements){const card=this.createAchievementCard(achievement,true);achievementsList.appendChild(card);}
for(const achievement of lockedAchievements){const card=this.createAchievementCard(achievement,false);achievementsList.appendChild(card);}
if(allAchievements.length===0){achievementsList.innerHTML='<div class="loading-spinner">æš‚æ— æˆå°±æ•°æ®</div>';}}catch(error){console.error('åˆ·æ–°æˆå°±æ¨¡æ€æ¡†å¤±è´¥:',error);const achievementsList=document.getElementById('achievementsList');if(achievementsList){achievementsList.innerHTML='<div class="loading-spinner">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</div>';}}}
createAchievementCard(achievement,unlocked){const card=document.createElement('div');card.className=`achievement-card ${unlocked?'unlocked':'locked'}`;let condition={};try{condition=JSON.parse(achievement.condition||'{}');}catch(e){console.warn('è§£ææˆå°±æ¡ä»¶å¤±è´¥:',e);}
const progress=achievement.progress||0;const target=achievement.target||1;const progressPercentage=target>0?Math.min(100,Math.round((progress/target)*100)):0;card.innerHTML=`<div class="achievement-badge">${achievement.icon||'ğŸ†'}</div><div class="achievement-content"><h3 class="achievement-name">${achievement.name}</h3><p class="achievement-description">${achievement.description}</p>${unlocked?`<div class="achievement-unlocked-date">è§£é”æ—¶é—´:${new Date(achievement.unlocked_date).toLocaleDateString()}</div>`:`<div class="achievement-progress"><div class="progress-bar-container"><div class="progress-bar-fill"style="width: ${progressPercentage}%"></div></div><span class="progress-text">${progress}/${target}</span></div>`}</div>`;return card;}
openModal(modalId){const modal=document.getElementById(modalId);if(modal){modal.classList.add('show');modal.style.display='flex';}}
closeModal(modalId){const modal=document.getElementById(modalId);if(modal){modal.classList.remove('show');modal.style.display='none';}}
closeAchievementsModal(){this.closeModal('achievementsModal');}
showToast(message,type='info'){const toast=document.createElement('div');toast.className=`toast toast-${type}`;toast.textContent=message;toast.style.cssText=`position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:${type==='success'?'var(--success-color)':type==='error'?'var(--error-color)':'var(--info-color)'};color:white;padding:12px 24px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.2);z-index:1000;animation:fade-in 0.3s ease;`;document.body.appendChild(toast);setTimeout(()=>{if(toast.parentNode){toast.style.animation='fade-out 0.3s ease forwards';setTimeout(()=>{if(toast.parentNode){toast.parentNode.removeChild(toast);}},300);}},3000);}
showErrorMessage(message){const errorEl=document.createElement('div');errorEl.id='app-error';errorEl.innerHTML=`<div style="padding: 16px; background: #ffebee; color: #c62828; border-radius: 8px; margin: 16px; text-align: center;"><strong>âš ï¸ é”™è¯¯ï¼š</strong>${message}<button id="retryBtn"style="margin-left: 12px; padding: 4px 12px; background: #c62828; color: white; border: none; border-radius: 4px; cursor: pointer;">é‡è¯•</button></div>`;const container=document.querySelector('.container');if(container){container.prepend(errorEl);const retryBtn=document.getElementById('retryBtn');if(retryBtn){retryBtn.addEventListener('click',()=>{location.reload();});}}}
async checkNotificationPermission(){if('Notification'in window){if(Notification.permission==='default'){try{const permission=await Notification.requestPermission();console.log('é€šçŸ¥æƒé™çŠ¶æ€:',permission);}catch(error){console.error('è¯·æ±‚é€šçŸ¥æƒé™å¤±è´¥:',error);}}}}
async initWeatherModule(){console.log('ğŸŒ¤ï¸ åˆå§‹åŒ–å¤©æ°”æ¨¡å—...');const weatherCard=document.querySelector('.weather-card');if(!weatherCard){console.warn('æœªæ‰¾åˆ°å¤©æ°”å¡ç‰‡å®¹å™¨');return;}
if(!weatherCard.querySelector('.refresh-weather-btn')){const refreshBtn=document.createElement('button');refreshBtn.className='refresh-weather-btn';refreshBtn.innerHTML='ğŸ”„ åˆ·æ–°å¤©æ°”';refreshBtn.title='æ‰‹åŠ¨åˆ·æ–°å¤©æ°”æ•°æ®';refreshBtn.addEventListener('click',()=>this.refreshWeatherData());weatherCard.appendChild(refreshBtn);}
const loadingEl=document.createElement('div');loadingEl.className='weather-loading';loadingEl.innerHTML='â³ è·å–å¤©æ°”æ•°æ®ä¸­...';weatherCard.appendChild(loadingEl);try{const weatherData=await this.weatherService.getWeatherData();const recommendation=this.weatherService.getWaterRecommendation(weatherData);this.updateWeatherUI(weatherData,recommendation);await this.waterRecorder.updateWeatherAdjustment(recommendation.adjustment);this.updateUI();this.startWeatherAutoRefresh();console.log('âœ… å¤©æ°”æ¨¡å—åˆå§‹åŒ–å®Œæˆ',{weatherData,recommendation});}catch(error){console.error('âŒ å¤©æ°”æ¨¡å—åˆå§‹åŒ–å¤±è´¥:',error);const weatherInfo=document.getElementById('weatherInfo');const waterRecommendation=document.getElementById('waterRecommendation');if(weatherInfo){weatherInfo.textContent='å¤©æ°”æ•°æ®è·å–å¤±è´¥ï¼Œä½¿ç”¨ç¼“å­˜æ•°æ®';weatherInfo.style.color='#ff6b6b';}
if(waterRecommendation){waterRecommendation.textContent='æ¨èå–æ°´é‡ï¼š1600ml (çº¦8æ¯)';}}finally{const loadingEl=weatherCard.querySelector('.weather-loading');if(loadingEl){loadingEl.remove();}}}
updateWeatherUI(weatherData,recommendation){const weatherInfo=document.getElementById('weatherInfo');const waterRecommendation=document.getElementById('waterRecommendation');if(!weatherInfo||!waterRecommendation)return;const formattedInfo=this.weatherService.formatWeatherInfo(weatherData);weatherInfo.textContent=formattedInfo;if(!this.weatherService.isOnline){weatherInfo.style.color='#ff6b6b';weatherInfo.textContent+=' (ç¦»çº¿æ¨¡å¼)';}else{weatherInfo.style.color='';}
const recommendedML=recommendation.adjustedGoal*200;waterRecommendation.textContent=`æ¨èå–æ°´é‡ï¼š${recommendedML}ml(çº¦${recommendation.adjustedGoal}æ¯)`;const reasonEl=document.createElement('div');reasonEl.className='weather-reason';reasonEl.textContent=recommendation.reason;reasonEl.style.fontSize='0.85em';reasonEl.style.color='#666';reasonEl.style.marginTop='5px';const weatherCard=document.querySelector('.weather-card');if(weatherCard){const oldReason=weatherCard.querySelector('.weather-reason');if(oldReason)oldReason.remove();const oldOffline=weatherCard.querySelector('.weather-offline');if(oldOffline)oldOffline.remove();weatherCard.appendChild(reasonEl);if(!this.weatherService.isOnline){const offlineEl=document.createElement('div');offlineEl.className='weather-offline';offlineEl.textContent='å½“å‰å¤„äºç¦»çº¿çŠ¶æ€ï¼Œæ­£åœ¨ä½¿ç”¨ç¼“å­˜çš„å¤©æ°”æ•°æ®ã€‚';weatherCard.appendChild(offlineEl);}}}
async refreshWeatherData(){console.log('ğŸ”„ æ‰‹åŠ¨åˆ·æ–°å¤©æ°”æ•°æ®');const weatherCard=document.querySelector('.weather-card');if(!weatherCard)return;const refreshBtn=weatherCard.querySelector('.refresh-weather-btn');if(refreshBtn){refreshBtn.disabled=true;refreshBtn.innerHTML='â³ åˆ·æ–°ä¸­...';}
const loadingEl=document.createElement('div');loadingEl.className='weather-loading';loadingEl.innerHTML='æ­£åœ¨è·å–æœ€æ–°å¤©æ°”æ•°æ®...';weatherCard.appendChild(loadingEl);try{const weatherData=await this.weatherService.getWeatherData(true);const recommendation=this.weatherService.getWaterRecommendation(weatherData);this.updateWeatherUI(weatherData,recommendation);await this.waterRecorder.updateWeatherAdjustment(recommendation.adjustment);this.updateUI();this.showToast('å¤©æ°”æ•°æ®å·²æ›´æ–°','success');console.log('âœ… å¤©æ°”æ•°æ®æ‰‹åŠ¨åˆ·æ–°æˆåŠŸ',{weatherData,recommendation});}catch(error){console.error('âŒ å¤©æ°”æ•°æ®åˆ·æ–°å¤±è´¥:',error);this.showToast('å¤©æ°”æ•°æ®æ›´æ–°å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ','error');}finally{if(refreshBtn){refreshBtn.disabled=false;refreshBtn.innerHTML='ğŸ”„ åˆ·æ–°å¤©æ°”';}
const loadingEl=weatherCard.querySelector('.weather-loading');if(loadingEl){loadingEl.remove();}}}
startWeatherAutoRefresh(){if(this.weatherRefreshTimer){clearInterval(this.weatherRefreshTimer);}
const refreshInterval=2*60*60*1000;this.weatherRefreshTimer=setInterval(()=>{console.log('â° å®šæ—¶è‡ªåŠ¨åˆ·æ–°å¤©æ°”æ•°æ®');this.refreshWeatherData().catch(err=>{console.warn('è‡ªåŠ¨åˆ·æ–°å¤©æ°”å¤±è´¥:',err);});},refreshInterval);console.log(`â° å¤©æ°”è‡ªåŠ¨åˆ·æ–°å·²å¯åŠ¨ï¼Œæ¯${refreshInterval/1000/60/60}å°æ—¶åˆ·æ–°ä¸€æ¬¡`);}
stopWeatherAutoRefresh(){if(this.weatherRefreshTimer){clearInterval(this.weatherRefreshTimer);this.weatherRefreshTimer=null;console.log('â° å¤©æ°”è‡ªåŠ¨åˆ·æ–°å·²åœæ­¢');}}
openSettings(){console.log('æ‰“å¼€è®¾ç½®é¡µé¢');this.showToast('è®¾ç½®åŠŸèƒ½å¼€å‘ä¸­...','info');}
openMessagePreview(){console.log('æ‰“å¼€æ¶ˆæ¯é¢„è§ˆ');this.openModal('messagePreviewModal');this.initMessagePreview();}
closeMessagePreviewModal(){this.closeModal('messagePreviewModal');}
async initMessagePreview(){console.log('åˆå§‹åŒ–æ¶ˆæ¯é¢„è§ˆç•Œé¢');try{const messageGenerator=getMessageGenerator();await messageGenerator.init();this.bindMessagePreviewEvents(messageGenerator);this.updateMessagePreviewStats(messageGenerator);const goalProgress=document.getElementById('goalProgress');const goalProgressValue=document.getElementById('goalProgressValue');if(goalProgress&&goalProgressValue){goalProgress.addEventListener('input',()=>{goalProgressValue.textContent=`${goalProgress.value}%`;});}}catch(error){console.error('åˆå§‹åŒ–æ¶ˆæ¯é¢„è§ˆå¤±è´¥:',error);this.showToast('åˆå§‹åŒ–æ¶ˆæ¯é¢„è§ˆå¤±è´¥','error');}}
bindMessagePreviewEvents(messageGenerator){const generateMessageBtn=document.getElementById('generateMessageBtn');const generateMultipleBtn=document.getElementById('generateMultipleBtn');const randomizeBtn=document.getElementById('randomizeBtn');if(generateMessageBtn){generateMessageBtn.addEventListener('click',async()=>{await this.generateAndDisplayMessage(messageGenerator);});}
if(generateMultipleBtn){generateMultipleBtn.addEventListener('click',async()=>{await this.generateMultipleMessages(messageGenerator);});}
if(randomizeBtn){randomizeBtn.addEventListener('click',()=>{this.randomizePreviewConditions();});}}
async generateAndDisplayMessage(messageGenerator){try{const context=this.getPreviewContext();const message=await messageGenerator.generateReminderMessage(context);const style=this.detectMessageStyle(message,context);this.addMessageToList(message,style,context);this.updateGenerationCount();}catch(error){console.error('ç”Ÿæˆæ¶ˆæ¯å¤±è´¥:',error);this.showToast('ç”Ÿæˆæ¶ˆæ¯å¤±è´¥','error');}}
async generateMultipleMessages(messageGenerator){try{const messageList=document.getElementById('messageList');if(messageList){const emptyState=messageList.querySelector('.empty-state');if(emptyState){messageList.innerHTML='';}else{const items=messageList.querySelectorAll('.message-item');if(items.length>10){for(let i=0;i<items.length-5;i++){items[i].remove();}}}}
for(let i=0;i<5;i++){await this.generateAndDisplayMessage(messageGenerator);await new Promise(resolve=>setTimeout(resolve,100));}
this.showToast('å·²ç”Ÿæˆ5æ¡ä¸åŒæ–‡æ¡ˆ','success');}catch(error){console.error('æ‰¹é‡ç”Ÿæˆæ¶ˆæ¯å¤±è´¥:',error);this.showToast('æ‰¹é‡ç”Ÿæˆæ¶ˆæ¯å¤±è´¥','error');}}
getPreviewContext(){const timeSegment=document.getElementById('timeSegment').value;const temperature=parseInt(document.getElementById('temperature').value);const weatherCondition=document.getElementById('weatherCondition').value;const streakDays=parseInt(document.getElementById('streakDays').value);const unlockedAchievements=parseInt(document.getElementById('unlockedAchievements').value);const goalProgress=parseInt(document.getElementById('goalProgress').value)/100;let weatherCategory='comfortable';if(temperature>=30)weatherCategory='hot';else if(temperature>=25)weatherCategory='warm';else if(temperature>=18)weatherCategory='comfortable';else if(temperature>=10)weatherCategory='cool';else weatherCategory='cold';return{timeSegment,temperature,weatherCategory,weatherCondition,streakDays,unlockedCount:unlockedAchievements,dailyGoalProgress:goalProgress};}
detectMessageStyle(message,context){const styleMap={humorous:['å“ˆå“ˆ','~','!','æ°´æ¯å›','ææç¥'],scientific:['ç ”ç©¶è¡¨æ˜','æ–°é™ˆä»£è°¢','æ¯’ç´ æ’å‡º','æ°´åˆ†è’¸å‘'],encouraging:['åŠ æ²¹','åšæŒ','åŠªåŠ›','ä½ å¯ä»¥åšåˆ°'],warm:['ç…§é¡¾å¥½è‡ªå·±','æ¶¦æ¶¦å–‰å’™','å¯¹èº«ä½“å¥½'],cute:['æ°´å®','(âœ§Ï‰âœ§)','(à¹‘>á´—<à¹‘)','ä¸»äºº'],serious:['å»ºè®®','é¢„é˜²','ç¡®ä¿','åŠ¡å¿…']};for(const[style,keywords]of Object.entries(styleMap)){for(const keyword of keywords){if(message.includes(keyword)){return style;}}}
return'warm';}
addMessageToList(message,style,context){const messageList=document.getElementById('messageList');if(!messageList)return;const emptyState=messageList.querySelector('.empty-state');if(emptyState){messageList.innerHTML='';}
const messageItem=document.createElement('div');messageItem.className='message-item';const styleNames={humorous:'å¹½é»˜é£è¶£',scientific:'ç§‘æ™®çŸ¥è¯†',encouraging:'é¼“åŠ±åŠ æ²¹',warm:'æ¸©é¦¨æé†’',cute:'å¯çˆ±å–èŒ',serious:'è®¤çœŸä¸¥è‚ƒ'};const styleName=styleNames[style]||style;const timeNames={morning:'æ—©ä¸Š',noon:'ä¸­åˆ',afternoon:'ä¸‹åˆ',evening:'æ™šä¸Š',night:'æ·±å¤œ'};const timeName=timeNames[context.timeSegment]||context.timeSegment;messageItem.innerHTML=`<div class="message-style">${styleName}</div><div class="message-content">${message}</div><div class="message-meta"><small>æ¡ä»¶:${timeName},${context.temperature}Â°C,è¿ç»­${context.streakDays}å¤©</small></div>`;messageList.prepend(messageItem);messageList.scrollTop=0;}
randomizePreviewConditions(){const timeSegments=['morning','noon','afternoon','evening','night'];const randomTimeSegment=timeSegments[Math.floor(Math.random()*timeSegments.length)];const randomTemperature=Math.floor(Math.random()*56)-10;const weatherConditions=['æ™´','å¤šäº‘','é˜´','é›¨','é›ª'];const randomWeatherCondition=weatherConditions[Math.floor(Math.random()*weatherConditions.length)];const randomStreakDays=Math.floor(Math.random()*31);const randomUnlockedAchievements=Math.floor(Math.random()*11);const randomGoalProgress=Math.floor(Math.random()*101);document.getElementById('timeSegment').value=randomTimeSegment;document.getElementById('temperature').value=randomTemperature;document.getElementById('weatherCondition').value=randomWeatherCondition;document.getElementById('streakDays').value=randomStreakDays;document.getElementById('unlockedAchievements').value=randomUnlockedAchievements;document.getElementById('goalProgress').value=randomGoalProgress;document.getElementById('goalProgressValue').textContent=`${randomGoalProgress}%`;this.showToast('å·²éšæœºåŒ–é¢„è§ˆæ¡ä»¶','info');}
updateMessagePreviewStats(messageGenerator){const templateCount=messageGenerator.countTemplates?messageGenerator.countTemplates():0;const templateCountEl=document.getElementById('templateCount');if(templateCountEl){templateCountEl.textContent=templateCount;}
const availableStylesEl=document.getElementById('availableStyles');if(availableStylesEl){const styles=Object.keys(messageGenerator.templates||{});availableStylesEl.textContent=styles.length;}
this.generationCount=0;const generationCountEl=document.getElementById('generationCount');if(generationCountEl){generationCountEl.textContent=this.generationCount;}}
updateGenerationCount(){this.generationCount=(this.generationCount||0)+1;const generationCountEl=document.getElementById('generationCount');if(generationCountEl){generationCountEl.textContent=this.generationCount;}}
openHistory(){console.log('æ‰“å¼€å†å²è®°å½•');window.location.href='history.html';}
async handleWeeklyReport(){console.log('ğŸ“„ ç”Ÿæˆæœ¬å‘¨å¥åº·ç®€æŠ¥...');try{this.showToast('æ­£åœ¨ç”Ÿæˆå‘¨æŠ¥ï¼Œè¯·ç¨å€™...','info');const{generateWeeklyReport,downloadPDF}=await import('./src/logic/weekly-report.js');const pdfBlob=await generateWeeklyReport();downloadPDF(pdfBlob);this.showToast('å‘¨æŠ¥ç”ŸæˆæˆåŠŸï¼Œæ–‡ä»¶å·²å¼€å§‹ä¸‹è½½ï¼','success');}catch(error){console.error('ç”Ÿæˆå‘¨æŠ¥å¤±è´¥:',error);this.showToast(`å‘¨æŠ¥ç”Ÿæˆå¤±è´¥:${error.message}`,'error');}}
handleOnline(){console.log('ç½‘ç»œå·²æ¢å¤');this.showToast('ç½‘ç»œè¿æ¥å·²æ¢å¤','success');}
handleOffline(){console.log('ç½‘ç»œæ–­å¼€');this.showToast('ç½‘ç»œè¿æ¥å·²æ–­å¼€ï¼Œæ­£åœ¨ä½¿ç”¨ç¦»çº¿æ¨¡å¼','warning');}
async installPWA(){if(this.deferredPrompt){this.deferredPrompt.prompt();const{outcome}=await this.deferredPrompt.userChoice;console.log(`å®‰è£…ç»“æœ:${outcome}`);this.deferredPrompt=null;}}
addDebugButtons(){const actionSection=document.querySelector('.action-section');if(!actionSection)return;const debugContainer=document.createElement('div');debugContainer.className='debug-buttons';debugContainer.innerHTML=`<h4 style="margin: 16px 0 8px; color: #666; font-size: 14px;">ğŸ§ª è°ƒè¯•å·¥å…·</h4><div style="display: flex; gap: 8px; flex-wrap: wrap;"><button class="btn btn-secondary"id="debugReset">é‡ç½®ä»Šæ—¥</button><button class="btn btn-secondary"id="debugAdd5">+5æ¯</button><button class="btn btn-secondary"id="debugSetGoal">ç›®æ ‡:10æ¯</button><button class="btn btn-secondary"id="debugShowState">æ˜¾ç¤ºçŠ¶æ€</button></div>`;actionSection.parentNode.insertBefore(debugContainer,actionSection.nextSibling);const debugReset=document.getElementById('debugReset');const debugAdd5=document.getElementById('debugAdd5');const debugSetGoal=document.getElementById('debugSetGoal');const debugShowState=document.getElementById('debugShowState');if(debugReset){debugReset.addEventListener('click',async()=>{await this.waterRecorder.resetToday();this.updateUI();this.showToast('ä»Šæ—¥è®°å½•å·²é‡ç½®','info');});}
if(debugAdd5){debugAdd5.addEventListener('click',async()=>{const current=this.waterRecorder.getState().stats.todayCount;await this.waterRecorder.setDrinkCount(current+5);this.updateUI();this.showToast('å·²æ·»åŠ 5æ¯æ°´','success');});}
if(debugSetGoal){debugSetGoal.addEventListener('click',async()=>{await this.waterRecorder.updateDailyGoal(10);this.updateUI();this.showToast('æ¯æ—¥ç›®æ ‡å·²è®¾ä¸º10æ¯','success');});}
if(debugShowState){debugShowState.addEventListener('click',()=>{const state=this.waterRecorder.getState();console.log('åº”ç”¨å®Œæ•´çŠ¶æ€:',state);alert(`å½“å‰çŠ¶æ€ï¼š
ä»Šæ—¥æ¯æ•°:${state.stats.todayCount}
åŸºç¡€ç›®æ ‡:${state.stats.goal}æ¯
å¤©æ°”è°ƒæ•´:${state.stats.weatherAdjustment}æ¯
è°ƒæ•´åç›®æ ‡:${state.stats.weatherAdjustedGoal}æ¯
å®Œæˆç‡:${state.stats.completionRate}%å‰©ä½™æ¯æ•°:${state.stats.remainingCups}æ¯`);});}}}
const style=document.createElement('style');style.textContent=`@keyframes bounce{0%,100%{transform:translateY(0);}
50%{transform:translateY(-15px);}}@keyframes pulse{0%{transform:scale(1);}
50%{transform:scale(1.05);}
100%{transform:scale(1);}}@keyframes drop-splash{0%{transform:translateY(0)scale(1);opacity:0.8;}
100%{transform:translateY(-40px)scale(1.5);opacity:0;}}@keyframes slide-in{from{transform:translateX(100%);opacity:0;}
to{transform:translateX(0);opacity:1;}}@keyframes slide-out{from{transform:translateX(0);opacity:1;}
to{transform:translateX(100%);opacity:0;}}@keyframes fade-in{from{opacity:0;}
to{opacity:1;}}@keyframes fade-out{from{opacity:1;}
to{opacity:0;}}
.bounce{animation:bounce 0.5s ease;}.pulse{animation:pulse 1s ease;}.detailed-stats{background:var(--card-bg);border-radius:var(--border-radius-md);padding:16px;margin:16px 0;box-shadow:var(--shadow-sm);border:2px solid var(--border-color);}.stat-row{display:flex;justify-content:space-between;margin-bottom:8px;font-size:var(--font-size-sm);}.stat-label{color:var(--text-secondary);font-weight:normal;}.stat-value{color:var(--text-primary);font-weight:bold;}`;document.head.appendChild(style);document.addEventListener('DOMContentLoaded',()=>{window.waterApp=new WaterReminderApp();if(window.location.hostname==='localhost'||window.location.hostname==='127.0.0.1'){console.log('ğŸ”§ å¼€å‘æ¨¡å¼ï¼šå¯ç”¨è°ƒè¯•åŠŸèƒ½');}});export{WaterReminderApp};