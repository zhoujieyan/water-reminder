const CACHE_VERSION='20260210.1';const CACHE_NAME=`water-reminder-${CACHE_VERSION}`;const APP_NAME='æ°´å®æé†’';const PRECACHE_URLS=['./','./index.html','./style.css','./app.js','./manifest.json','./service-worker.js','./assets/icon-72.png','./assets/icon-96.png','./assets/icon-128.png','./assets/icon-144.png','./assets/icon-152.png','./assets/icon-192.png','./assets/icon-384.png','./assets/icon-512.png','./assets/favicon.ico','./assets/apple-touch-icon.png','./offline.html','./history.html','./history.js'];const CACHE_CONFIG={staticMaxAge:7*24*60*60*1000,apiMaxAge:60*60*1000,networkTimeout:5000};self.addEventListener('install',event=>{console.log(`[ServiceWorker]${APP_NAME}v${CACHE_VERSION}å®‰è£…ä¸­...`);event.waitUntil(caches.open(CACHE_NAME).then(cache=>{console.log(`[ServiceWorker]é¢„ç¼“å­˜ ${PRECACHE_URLS.length}ä¸ªæ ¸å¿ƒèµ„æº`);return cache.addAll(PRECACHE_URLS);}).then(()=>{console.log(`[ServiceWorker]${APP_NAME}é¢„ç¼“å­˜å®Œæˆ`);return self.skipWaiting();}).catch(error=>{console.error(`[ServiceWorker]å®‰è£…å¤±è´¥:`,error);}));});self.addEventListener('activate',event=>{console.log(`[ServiceWorker]${APP_NAME}v${CACHE_VERSION}æ¿€æ´»ä¸­...`);event.waitUntil(Promise.all([cleanOldCaches(),cleanExpiredCacheEntries(),self.clients.claim()]).then(()=>{console.log(`[ServiceWorker]${APP_NAME}v${CACHE_VERSION}æ¿€æ´»å®Œæˆ`);notifyClients({type:'SW_ACTIVATED',version:CACHE_VERSION});}));});self.addEventListener('fetch',event=>{const url=new URL(event.request.url);if(event.request.method!=='GET'||url.protocol==='chrome-extension:'){return;}
if(url.pathname.includes('/api/')||url.pathname.endsWith('.json')){event.respondWith(handleApiRequest(event.request));}else if(isStaticAsset(url)){event.respondWith(handleStaticRequest(event.request));}else{event.respondWith(handleGenericRequest(event.request));}});function isStaticAsset(url){const staticExtensions=['.css','.js','.png','.jpg','.jpeg','.gif','.svg','.ico','.woff','.woff2','.ttf'];return staticExtensions.some(ext=>url.pathname.endsWith(ext));}
async function handleStaticRequest(request){const cache=await caches.open(CACHE_NAME);const cachedResponse=await cache.match(request);if(cachedResponse){updateCacheInBackground(request,cache);return cachedResponse;}
try{const networkResponse=await fetchWithTimeout(request,CACHE_CONFIG.networkTimeout);if(networkResponse&&networkResponse.status===200){const responseToCache=networkResponse.clone();cache.put(request,responseToCache);}
return networkResponse;}catch(error){console.warn(`[ServiceWorker]é™æ€èµ„æºèŽ·å–å¤±è´¥:${request.url}`,error);if(request.destination==='document'){const offlineResponse=await cache.match('./offline.html');if(offlineResponse)return offlineResponse;}
return new Response('ç½‘ç»œä¸å¯ç”¨',{status:503,statusText:'Service Unavailable',headers:{'Content-Type':'text/plain'}});}}
async function handleApiRequest(request){try{const networkResponse=await fetchWithTimeout(request,CACHE_CONFIG.networkTimeout);if(networkResponse&&networkResponse.status===200){if(request.method==='GET'){const cache=await caches.open(CACHE_NAME);const responseToCache=networkResponse.clone();cache.put(request,responseToCache);}
return networkResponse;}
throw new Error(`APIè¯·æ±‚å¤±è´¥:${networkResponse?.status}`);}catch(error){console.warn(`[ServiceWorker]APIè¯·æ±‚å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ç¼“å­˜:${request.url}`,error);const cache=await caches.open(CACHE_NAME);const cachedResponse=await cache.match(request);if(cachedResponse){return cachedResponse;}
return new Response(JSON.stringify({error:'ç½‘ç»œä¸å¯ç”¨',message:'è¯·æ£€æŸ¥ç½‘ç»œè¿žæŽ¥åŽé‡è¯•',timestamp:new Date().toISOString()}),{status:503,headers:{'Content-Type':'application/json'}});}}
async function handleGenericRequest(request){try{const networkResponse=await fetchWithTimeout(request,CACHE_CONFIG.networkTimeout);return networkResponse;}catch(error){console.warn(`[ServiceWorker]è¯·æ±‚å¤±è´¥:${request.url}`,error);const cache=await caches.open(CACHE_NAME);if(request.destination==='document'){const offlineResponse=await cache.match('./offline.html');if(offlineResponse)return offlineResponse;}
const cachedResponse=await cache.match(request);if(cachedResponse)return cachedResponse;return cache.match('./offline.html');}}
async function updateCacheInBackground(request,cache){try{const networkResponse=await fetchWithTimeout(request,CACHE_CONFIG.networkTimeout);if(networkResponse&&networkResponse.status===200){cache.put(request,networkResponse);console.log(`[ServiceWorker]åŽå°æ›´æ–°ç¼“å­˜:${request.url}`);}}catch(error){}}
function fetchWithTimeout(request,timeout){return new Promise((resolve,reject)=>{const timer=setTimeout(()=>{reject(new Error('ç½‘ç»œè¯·æ±‚è¶…æ—¶'));},timeout);fetch(request).then(response=>{clearTimeout(timer);resolve(response);}).catch(error=>{clearTimeout(timer);reject(error);});});}
async function cleanOldCaches(){const cacheKeys=await caches.keys();const oldCaches=cacheKeys.filter(key=>key.startsWith('water-reminder-')&&key!==CACHE_NAME);console.log(`[ServiceWorker]å‘çŽ° ${oldCaches.length}ä¸ªæ—§ç¼“å­˜`);return Promise.all(oldCaches.map(cacheName=>{console.log(`[ServiceWorker]åˆ é™¤æ—§ç¼“å­˜:${cacheName}`);return caches.delete(cacheName);}));}
async function cleanExpiredCacheEntries(){const cache=await caches.open(CACHE_NAME);const requests=await cache.keys();const now=Date.now();let cleanedCount=0;await Promise.all(requests.map(async request=>{const response=await cache.match(request);if(!response)return;const dateHeader=response.headers.get('date');const cacheControl=response.headers.get('cache-control');if(dateHeader){const cachedDate=new Date(dateHeader).getTime();let maxAge=CACHE_CONFIG.staticMaxAge;if(request.url.includes('/api/')){maxAge=CACHE_CONFIG.apiMaxAge;}
if(now-cachedDate>maxAge){await cache.delete(request);cleanedCount++;console.log(`[ServiceWorker]æ¸…ç†è¿‡æœŸç¼“å­˜:${request.url}`);}}}));if(cleanedCount>0){console.log(`[ServiceWorker]å·²æ¸…ç† ${cleanedCount}ä¸ªè¿‡æœŸç¼“å­˜æ¡ç›®`);}}
async function notifyClients(message){const clients=await self.clients.matchAll();clients.forEach(client=>{client.postMessage(message);});}
self.addEventListener('push',event=>{console.log('[ServiceWorker] æŽ¨é€é€šçŸ¥æŽ¥æ”¶');if(!event.data){console.log('[ServiceWorker] æŽ¨é€æ•°æ®ä¸ºç©º');return;}
const data=event.data.json();const options={body:data.body||'ðŸ’§ è¯¥å–æ°´å•¦ï¼è®°å¾—è¡¥å……æ°´åˆ†å“¦~',icon:'./assets/icon-192.png',badge:'./assets/icon-72.png',vibrate:[200,100,200],data:{url:data.url||'./',timestamp:data.timestamp||new Date().toISOString()},actions:[{action:'drink',title:'ðŸ’§ å–äº†ä¸€æ¯'},{action:'skip',title:'â­ï¸ è·³è¿‡'},{action:'snooze',title:'â° 10åˆ†é’ŸåŽ'}],tag:'water-reminder',renotify:true};event.waitUntil(self.registration.showNotification(data.title||'æ°´å®æé†’',options));});self.addEventListener('notificationclick',event=>{console.log('[ServiceWorker] é€šçŸ¥ç‚¹å‡»:',event.action);event.notification.close();if(event.action==='drink'){event.waitUntil(clients.matchAll({type:'window'}).then(clientList=>{if(clientList.length>0){const client=clientList[0];client.postMessage({type:'DRINK_RECORDED',timestamp:new Date().toISOString()});return client.focus();}
return clients.openWindow('./');}));}else if(event.action==='skip'){event.waitUntil(clients.matchAll({type:'window'}).then(clientList=>{if(clientList.length>0){const client=clientList[0];client.postMessage({type:'REMINDER_SKIPPED',timestamp:new Date().toISOString()});}}));}else if(event.action==='snooze'){event.waitUntil(new Promise(resolve=>{setTimeout(()=>{self.registration.showNotification('æ°´å®æé†’',{body:'â° 10åˆ†é’Ÿåˆ°äº†ï¼Œè¯¥å–æ°´å•¦ï¼',icon:'./assets/icon-192.png',tag:'water-reminder-snooze'});resolve();},10*60*1000);}));}else{event.waitUntil(clients.openWindow('./'));}});self.addEventListener('message',event=>{console.log('[ServiceWorker] æ”¶åˆ°æ¶ˆæ¯:',event.data);if(event.data.type==='SKIP_WAITING'){self.skipWaiting();}
if(event.data.type==='UPDATE_CACHE'){caches.open(CACHE_NAME).then(cache=>{cache.addAll(event.data.urls||[]);});}});console.log(`[ServiceWorker]${APP_NAME}v${CACHE_VERSION}å·²åŠ è½½`);